<!DOCTYPE html>

<html lang="zh-tw">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>Daichou&#39;s blog</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://daichou.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://daichou.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://daichou.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://daichou.github.io/manifest.json">
    <link rel="mask-icon" href="https://daichou.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://daichou.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-161437179-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>

</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://daichou.github.io/">Daichou&#39;s blog</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://daichou.github.io/">Posts</a>
  
    <a class="color-link nav-link" href="https://daichou.github.io/tags/">Tags</a>
  
    <a class="color-link nav-link" href="https://daichou.github.io/archives/">Archives</a>
  
    <a class="color-link nav-link" href="https://daichou.github.io/about/">About me</a>
  
  <a class="color-link nav-link" href="https://daichou.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        
    <a class="social-icon" href="mailto:tommy0705c@gmail.com" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <a class="social-icon" href="https://gattacangin.blogspot.com/" target="_blank" rel="noopener" title="Blogger">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M16.4225354,15.183099 C16.7605636,15.183099 17.0422536,15.3145545 17.2676055,15.5774654 C17.4929581,15.8028172 17.6056345,16.0845072 17.6056345,16.4225354 C17.6056345,16.7605636 17.4929581,17.0422536 17.2676055,17.2676055 C17.0422536,17.4929581 16.7605636,17.6056345 16.4225354,17.6056345 L11.5211272,17.6056345 C11.183099,17.6056345 10.9014088,17.4929581 10.6760564,17.2676055 C10.4507043,17.0422536 10.3380283,16.7605636 10.3380283,16.4225354 C10.3380283,16.0845072 10.4507043,15.8028172 10.6760564,15.5774654 C10.9014088,15.3145545 11.183099,15.183099 11.5211272,15.183099 L16.4225354,15.183099 Z M11.5211272,11.5774646 C11.183099,11.5774646 10.9014088,11.4647886 10.6760564,11.2394368 C10.4507043,11.0140849 10.3380283,10.7323948 10.3380283,10.3943664 C10.3380283,10.0563382 10.4507043,9.77464807 10.6760564,9.54929597 C10.9014088,9.3239438 11.183099,9.21126771 11.5211272,9.21126771 L14.6760568,9.21126771 C15.0140849,9.21126771 15.295775,9.3239438 15.5211268,9.54929597 C15.7464787,9.77464807 15.8591546,10.0563382 15.8591546,10.3943664 C15.8591546,10.7323948 15.7464787,11.0140849 15.5211268,11.2394368 C15.295775,11.4647886 15.0140849,11.5774646 14.6760568,11.5774646 L11.5211272,11.5774646 Z M18.7887323,11.5774646 L18.7887323,9.21126771 C18.7887323,8.23474189 18.431925,7.38967148 17.7183104,6.67605648 C17.004695,5.9624414 16.1596245,5.60563386 15.183099,5.60563386 L10.3943663,5.60563386 C9.41784045,5.60563386 8.57277003,5.9624414 7.85915503,6.67605648 C7.14553995,7.38967148 6.78873241,8.23474189 6.78873241,9.21126771 L6.78873241,17.6056345 C6.78873241,18.58216 7.14553995,19.4272304 7.85915503,20.1408458 C8.57277003,20.8544604 9.41784045,21.2112677 10.3943663,21.2112677 L17.6056345,21.2112677 C18.58216,21.2112677 19.4272304,20.8544604 20.1408458,20.1408458 C20.8544604,19.4272304 21.2112677,18.58216 21.2112677,17.6056345 L21.2112677,14 C21.2112677,13.6619718 21.0985918,13.3802818 20.8732399,13.1549299 C20.6478873,12.9295781 20.3661969,12.8169022 20.0281687,12.8169022 C19.6901405,12.8169022 19.3896714,12.7042258 19.1267613,12.4788732 C18.9014086,12.2159623 18.7887323,11.9154928 18.7887323,11.5774646 L18.7887323,11.5774646 Z M23.6338031,2 C24.2723005,2 24.8169014,2.24413145 25.2676059,2.73239436 C25.7558686,3.18309863 26,3.72769958 26,4.36619722 L26,23.6338031 C26,24.2723005 25.7558686,24.8356809 25.2676059,25.3239444 C24.8169014,25.7746481 24.2723005,26 23.6338031,26 L4.36619722,26 C3.7276995,26 3.16431919,25.7746481 2.67605628,25.3239444 C2.22535209,24.8356809 2,24.2723005 2,23.6338031 L2,4.36619722 C2,3.72769958 2.22535209,3.18309863 2.67605628,2.73239436 C3.16431919,2.24413145 3.7276995,2 4.36619722,2 L23.6338031,2 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://github.com/Daichou" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    <a class="social-icon" href="#ZgotmplZ" target="_blank" rel="noopener" title="Stack Overflow">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M20.8863636,23.7090909 L20.8863636,17.3818182 L22.9863636,17.3818182 L22.9863636,25.8090909 L4.03181818,25.8090909 L4.03181818,17.3818182 L6.13181818,17.3818182 L6.13181818,23.7090909 L20.8863636,23.7090909 Z M8.45,16.7818182 L8.88636364,14.7090909 L19.1954545,16.8636364 L18.7590909,18.9363636 L8.45,16.7818182 Z M9.81363636,11.8727273 L10.6863636,9.93636364 L20.2318182,14.4090909 L19.3590909,16.3181818 L9.81363636,11.8727273 Z M12.4590909,7.18181818 L13.7954545,5.57272727 L21.8954545,12.3090909 L20.5590909,13.9181818 L12.4590909,7.18181818 Z M17.6954545,2.19090909 L23.9681818,10.6454545 L22.2772727,11.9 L16.0045455,3.44545455 L17.6954545,2.19090909 Z M8.23181818,21.5818182 L8.23181818,19.4818182 L18.7590909,19.4818182 L18.7590909,21.5818182 L8.23181818,21.5818182 Z"></path>
        </svg>
    </a>
    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://daichou.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">PWM產生方式</h1>
    
    <time>July 31, 2016</time>
    
    <div>
        <p>
        <h2 id="pwm簡述">PWM簡述</h2>
<p>PWM為Pulse Width Modulation的縮寫，對於只有high和low的數位訊號來說，如何用high,low比率調整出類似類比訊號為PWM的用處，另外大多數馬達也透過PWM來驅動轉速，LED由於只吃固定電壓，所以常用PWM來調整亮度。</p>
<p><a href="https://4.bp.blogspot.com/-ttPaWLzauvs/V522Kci1JvI/AAAAAAAABas/zjzq5WZFsHc5uJ-jfJzE5n-NTmXL9cviwCLcB/s1600/PWM.png"><img src="https://4.bp.blogspot.com/-ttPaWLzauvs/V522Kci1JvI/AAAAAAAABas/zjzq5WZFsHc5uJ-jfJzE5n-NTmXL9cviwCLcB/s640/PWM.png" alt=""></a></p>
<p>duty cycle(占空比)為整個high時間除以週期時間(D = DT/T)。</p>
<h2 id="pwm產生方式">PWM產生方式</h2>
<p>PWM主要又三種方式產生：硬體內建PWM模組、中斷產生、迴圈。</p>
<h3 id="硬體內建pwm模組">硬體內建PWM模組</h3>
<p>MCU內常內建PWM模組，以PIC系列為例，有CCP(Capture/Compare/PWM)模組、Output Compare模組和PWM模組。透過設定timer和暫存去達成PWM輸出。以下以dsPIC30F4013的Output Compare做示範。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;xc.h&gt;  </span><span style="color:#75715e">
</span><span style="color:#75715e"></span>  
<span style="color:#75715e">// FOSC
</span><span style="color:#75715e"></span><span style="color:#75715e">#pragma config FOSFPR = XT_PLL4         </span><span style="color:#75715e">// Oscillator (XT w/PLL 4x)
</span><span style="color:#75715e"></span><span style="color:#75715e">#pragma config FCKSMEN = CSW_FSCM_OFF   </span><span style="color:#75715e">// Clock Switching and Monitor (Sw Disabled, Mon Disabled)
</span><span style="color:#75715e"></span>  
<span style="color:#75715e">// FWDT
</span><span style="color:#75715e"></span><span style="color:#75715e">#pragma config FWPSB = WDTPSB_16        </span><span style="color:#75715e">// WDT Prescaler B (1:16)
</span><span style="color:#75715e"></span><span style="color:#75715e">#pragma config FWPSA = WDTPSA_512       </span><span style="color:#75715e">// WDT Prescaler A (1:512)
</span><span style="color:#75715e"></span><span style="color:#75715e">#pragma config WDT = WDT_OFF            </span><span style="color:#75715e">// Watchdog Timer (Disabled)
</span><span style="color:#75715e"></span>  
<span style="color:#75715e">// FBORPOR
</span><span style="color:#75715e"></span><span style="color:#75715e">#pragma config FPWRT = PWRT_64          </span><span style="color:#75715e">// POR Timer Value (64ms)
</span><span style="color:#75715e"></span><span style="color:#75715e">#pragma config BODENV = BORV20          </span><span style="color:#75715e">// Brown Out Voltage (Reserved)
</span><span style="color:#75715e"></span><span style="color:#75715e">#pragma config BOREN = PBOR_ON          </span><span style="color:#75715e">// PBOR Enable (Enabled)
</span><span style="color:#75715e"></span><span style="color:#75715e">#pragma config MCLRE = MCLR_EN          </span><span style="color:#75715e">// Master Clear Enable (Enabled)
</span><span style="color:#75715e"></span>  
<span style="color:#75715e">// FGS
</span><span style="color:#75715e"></span><span style="color:#75715e">#pragma config GWRP = GWRP_OFF          </span><span style="color:#75715e">// General Code Segment Write Protect (Disabled)
</span><span style="color:#75715e"></span><span style="color:#75715e">#pragma config GCP = CODE_PROT_OFF      </span><span style="color:#75715e">// General Segment Code Protection (Disabled)
</span><span style="color:#75715e"></span>  
<span style="color:#75715e">// FICD
</span><span style="color:#75715e"></span><span style="color:#75715e">#pragma config ICS = ICS_PGD            </span><span style="color:#75715e">// Comm Channel Select (Use PGC/EMUC and PGD/EMUD)
</span><span style="color:#75715e"></span>  
<span style="color:#75715e">#define Tcy 10000000            </span><span style="color:#75715e">//10MHz oscillator with 4xPLL -&gt; 10&#39;000&#39;000MIPS
</span><span style="color:#75715e"></span>
  
<span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e">//  main routine
</span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">**</span> argv) {
      
<span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e">//     IO Plan
</span><span style="color:#75715e"></span>      
    TRISA <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0000</span>;
    TRISB <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0000</span>;
    TRISC <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0000</span>;
    TRISD <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0000</span>;     <span style="color:#75715e">//RD1,RD2,RD3,RD4 -&gt; PWM OC pin
</span><span style="color:#75715e"></span>    TRISF <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0000</span>;
    ADPCFG <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xFFFF</span>;

<span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e">//   initialize PWM 
</span><span style="color:#75715e"></span>      
    <span style="color:#75715e">//PR2 = 50000;      1:256-&gt; 200 HZ
</span><span style="color:#75715e"></span>    PR2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">25000</span>;
    OC1RS <span style="color:#f92672">=</span> <span style="color:#ae81ff">1875</span>;
    OC1CON <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0006</span>;    <span style="color:#75715e">//Set PWM mode on OC1,Fault pin disable,Timer2 is source
</span><span style="color:#75715e"></span>    OC2RS <span style="color:#f92672">=</span> <span style="color:#ae81ff">1875</span>;
    OC2CON <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0006</span>;    <span style="color:#75715e">//Set PWM mode on OC2,Fault pin disable,Timer2 is source
</span><span style="color:#75715e"></span>    OC3RS <span style="color:#f92672">=</span> <span style="color:#ae81ff">1875</span>;
    OC3CON <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0006</span>;    <span style="color:#75715e">//Set PWM mode on OC3,Fault pin disable,Timer2 is source
</span><span style="color:#75715e"></span>    OC4RS <span style="color:#f92672">=</span> <span style="color:#ae81ff">1875</span>;
    OC4CON <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0006</span>;    <span style="color:#75715e">//Set PWM mode on OC4,Fault pin disable,Timer2 is source
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//IEC0bits.T2IE = 1;  //enable Timer2 interrupt 
</span><span style="color:#75715e"></span>   <span style="color:#75715e">// T2CON = 0x8000;     //Configure Timer2(Timer on,continue in IDLE,not gate
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">//                      ,1:256 prescaler,internal clock)
</span><span style="color:#75715e"></span>    T2CON <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x8010</span>;
    TMR2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>);
}
}
</code></pre></div><p>由於每個MCU的PWM實際細節都不一樣，所以讀者請自行閱讀datasheet來應用硬體內建的PWM。<br>
dsPIC30F系列的Output Compare PWM模組要應用時須將OCxCON 暫存器中的OCM設為&rsquo;110'或&rsquo;111&rsquo;。設定順序為:<br>
1.設定PRy(Period register)表示PWM的週期。<br>
2.再來設定OCxRS暫存器表示duty cycle。<br>
3.設定OCM。<br>
4.設定timer，並開啟timer。</p>
<p>PWM 週期 ＝ [(PRy+1)]*Tcy*(TMRx presclaer value)。 (Tcy為振盪器頻率*PLL/4)<br>
PWM 頻率為週期倒數。<br>
詳細設定在<a href="http://ww1.microchip.com/downloads/en/DeviceDoc/70157C.pdf">http://ww1.microchip.com/downloads/en/DeviceDoc/70157C.pdf</a>中有詳細描述。</p>
<h3 id="中斷產生pwm">中斷產生PWM</h3>
<p>利用Timer中斷來切換PWM進入duty cycle，有兩種方法。</p>
<p>一、用一個或兩個timer，先輸出high，計算PWM在high所需時間，設定好Timer 週期(中斷條件)，當Timer發生中斷，將輸出切為low，並在計算PWM在low所需時間，同樣設定好Timer週期，當Timer發生中斷回到一開始重頭來過。也可用兩個Timer一個設為high所需時間，一個為period，當high的timer 中斷發生，關閉其中斷與timer，並將輸出設為low，等待period 的Timer發生中斷，在開啟high 的timer中斷。</p>
<p>二、用一個timer中斷，當其中斷將counter加一，一旦couner的值大於duty cycle則切為low，當counter的值大於period則歸零。以下為範例(使用PIC18F452)。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">/*
</span><span style="color:#75715e"> * File:   newmainXC16.c
</span><span style="color:#75715e"> * Author: asus-h
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * Created on 2015?2?9?, ?? 9:49
</span><span style="color:#75715e"> */</span>


<span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;xc.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#pragma config OSC = HS, WDT=OFF, LVP=OFF,PWRT = OFF
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> counter,pwm_val_1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>,pwm_val_2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>,pwm_val_3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>,pwm_val_4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>;
<span style="color:#66d9ef">int</span> change <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init_timer</span>();
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">do_PWM</span>();

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {
    TRISC <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xEF</span>;
    TRISB <span style="color:#f92672">=</span> <span style="color:#ae81ff">0b11111111</span>;
    TRISD <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00</span>;
    <span style="color:#75715e">//TRISCbits.TRISC4 = 0;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//unsigned int duty = 500;
</span><span style="color:#75715e"></span>   <span style="color:#75715e">// T3CONbits.T3CCP2=0;
</span><span style="color:#75715e"></span>   <span style="color:#75715e">// T3CONbits.T3CCP1=0;
</span><span style="color:#75715e"></span>    INTCON2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0b00000001</span>;
    
    init_timer();
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}



<span style="color:#66d9ef">void</span> interrupt <span style="color:#a6e22e">ISR</span>()
{
    <span style="color:#66d9ef">if</span>(T0IF)
    {

        TMR0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">65530</span>;
        counter<span style="color:#f92672">++</span>;

        INTCON <span style="color:#f92672">&amp;=</span>  <span style="color:#f92672">~</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>T0IF);
        <span style="color:#75715e">//INTCON = 0b11111110; //clear overflow bit;
</span><span style="color:#75715e"></span>        T0IF <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        do_PWM();
    }
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init_timer</span>()
{
    TMR0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">65500</span>;
    TMR1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    T0CON <span style="color:#f92672">=</span> <span style="color:#ae81ff">0b10000001</span>;
    T1CON <span style="color:#f92672">=</span> <span style="color:#ae81ff">0b10000000</span>;
    <span style="color:#75715e">//OPTION = 0B00001000;
</span><span style="color:#75715e"></span>    INTCON <span style="color:#f92672">=</span> <span style="color:#ae81ff">0b11111110</span>;
    PIR1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0b000000011</span>;
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">do_PWM</span>()
{
    TMR0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">65530</span> ;
        counter<span style="color:#f92672">++</span>;
        <span style="color:#66d9ef">if</span>(counter<span style="color:#f92672">&lt;=</span>pwm_val_1)
           PORTDbits.RD4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
        <span style="color:#66d9ef">else</span>
          PORTDbits.RD4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

        <span style="color:#66d9ef">if</span>(counter<span style="color:#f92672">&lt;=</span>pwm_val_2)
            PORTDbits.RD5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
        <span style="color:#66d9ef">else</span>
            PORTDbits.RD5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

        <span style="color:#66d9ef">if</span>(counter<span style="color:#f92672">&lt;=</span>pwm_val_3)
            PORTDbits.RD6 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
        <span style="color:#66d9ef">else</span>
            PORTDbits.RD6 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

        <span style="color:#66d9ef">if</span>(counter<span style="color:#f92672">&lt;=</span>pwm_val_4)
            PORTDbits.RD7 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
        <span style="color:#66d9ef">else</span>
            PORTDbits.RD7 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
            
        <span style="color:#66d9ef">if</span>(counter <span style="color:#f92672">==</span> <span style="color:#ae81ff">100</span>)
            counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
         T0IF <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>此方法缺點為PWM頻率難以調整，不過對於本身PWM模組缺乏或過少之MCU，此法十分有效。</p>
<h3 id="迴圈產生pwm">迴圈產生PWM</h3>
<p>以迴圈直接產生PWM，可以用一個counter當作現在情況，當迴圈執行次數超過duty cycle的值時，調整high low，這方法十分簡單，但如果要有準確的頻率需要將程式編成組語計算其所需時間，並用NOP指令挑整週期。這方法會佔走整個CPU，十分無效率，但其可以結合輪詢等固定時間需要執行的功能，對於低階，簡單的系統有其應用空間。</p>

        </p>
    </div>
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "daichou-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://daichou.github.io/tags/hardware">#hardware</a>
        
            <a class="tag" href="https://daichou.github.io/tags/c/c&#43;&#43;">#C/C&#43;&#43;</a>
        
      
    </div>


        

<link rel="stylesheet" type="text/css" href="https://daichou.github.io/css/katex.min.css">
<script type="text/javascript" src="https://daichou.github.io/js/katex.min.js"></script>
<script type="text/javascript" src="https://daichou.github.io/js/auto-render.min.js"onload="renderMathInElement(document.body);"></script>

        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        
    <a class="social-icon" href="mailto:tommy0705c@gmail.com" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <a class="social-icon" href="https://gattacangin.blogspot.com/" target="_blank" rel="noopener" title="Blogger">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M16.4225354,15.183099 C16.7605636,15.183099 17.0422536,15.3145545 17.2676055,15.5774654 C17.4929581,15.8028172 17.6056345,16.0845072 17.6056345,16.4225354 C17.6056345,16.7605636 17.4929581,17.0422536 17.2676055,17.2676055 C17.0422536,17.4929581 16.7605636,17.6056345 16.4225354,17.6056345 L11.5211272,17.6056345 C11.183099,17.6056345 10.9014088,17.4929581 10.6760564,17.2676055 C10.4507043,17.0422536 10.3380283,16.7605636 10.3380283,16.4225354 C10.3380283,16.0845072 10.4507043,15.8028172 10.6760564,15.5774654 C10.9014088,15.3145545 11.183099,15.183099 11.5211272,15.183099 L16.4225354,15.183099 Z M11.5211272,11.5774646 C11.183099,11.5774646 10.9014088,11.4647886 10.6760564,11.2394368 C10.4507043,11.0140849 10.3380283,10.7323948 10.3380283,10.3943664 C10.3380283,10.0563382 10.4507043,9.77464807 10.6760564,9.54929597 C10.9014088,9.3239438 11.183099,9.21126771 11.5211272,9.21126771 L14.6760568,9.21126771 C15.0140849,9.21126771 15.295775,9.3239438 15.5211268,9.54929597 C15.7464787,9.77464807 15.8591546,10.0563382 15.8591546,10.3943664 C15.8591546,10.7323948 15.7464787,11.0140849 15.5211268,11.2394368 C15.295775,11.4647886 15.0140849,11.5774646 14.6760568,11.5774646 L11.5211272,11.5774646 Z M18.7887323,11.5774646 L18.7887323,9.21126771 C18.7887323,8.23474189 18.431925,7.38967148 17.7183104,6.67605648 C17.004695,5.9624414 16.1596245,5.60563386 15.183099,5.60563386 L10.3943663,5.60563386 C9.41784045,5.60563386 8.57277003,5.9624414 7.85915503,6.67605648 C7.14553995,7.38967148 6.78873241,8.23474189 6.78873241,9.21126771 L6.78873241,17.6056345 C6.78873241,18.58216 7.14553995,19.4272304 7.85915503,20.1408458 C8.57277003,20.8544604 9.41784045,21.2112677 10.3943663,21.2112677 L17.6056345,21.2112677 C18.58216,21.2112677 19.4272304,20.8544604 20.1408458,20.1408458 C20.8544604,19.4272304 21.2112677,18.58216 21.2112677,17.6056345 L21.2112677,14 C21.2112677,13.6619718 21.0985918,13.3802818 20.8732399,13.1549299 C20.6478873,12.9295781 20.3661969,12.8169022 20.0281687,12.8169022 C19.6901405,12.8169022 19.3896714,12.7042258 19.1267613,12.4788732 C18.9014086,12.2159623 18.7887323,11.9154928 18.7887323,11.5774646 L18.7887323,11.5774646 Z M23.6338031,2 C24.2723005,2 24.8169014,2.24413145 25.2676059,2.73239436 C25.7558686,3.18309863 26,3.72769958 26,4.36619722 L26,23.6338031 C26,24.2723005 25.7558686,24.8356809 25.2676059,25.3239444 C24.8169014,25.7746481 24.2723005,26 23.6338031,26 L4.36619722,26 C3.7276995,26 3.16431919,25.7746481 2.67605628,25.3239444 C2.22535209,24.8356809 2,24.2723005 2,23.6338031 L2,4.36619722 C2,3.72769958 2.22535209,3.18309863 2.67605628,2.73239436 C3.16431919,2.24413145 3.7276995,2 4.36619722,2 L23.6338031,2 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://github.com/Daichou" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    <a class="social-icon" href="#ZgotmplZ" target="_blank" rel="noopener" title="Stack Overflow">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M20.8863636,23.7090909 L20.8863636,17.3818182 L22.9863636,17.3818182 L22.9863636,25.8090909 L4.03181818,25.8090909 L4.03181818,17.3818182 L6.13181818,17.3818182 L6.13181818,23.7090909 L20.8863636,23.7090909 Z M8.45,16.7818182 L8.88636364,14.7090909 L19.1954545,16.8636364 L18.7590909,18.9363636 L8.45,16.7818182 Z M9.81363636,11.8727273 L10.6863636,9.93636364 L20.2318182,14.4090909 L19.3590909,16.3181818 L9.81363636,11.8727273 Z M12.4590909,7.18181818 L13.7954545,5.57272727 L21.8954545,12.3090909 L20.5590909,13.9181818 L12.4590909,7.18181818 Z M17.6954545,2.19090909 L23.9681818,10.6454545 L22.2772727,11.9 L16.0045455,3.44545455 L17.6954545,2.19090909 Z M8.23181818,21.5818182 L8.23181818,19.4818182 L18.7590909,19.4818182 L18.7590909,21.5818182 L8.23181818,21.5818182 Z"></path>
        </svg>
    </a>
    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://daichou.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>