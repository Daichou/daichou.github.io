<!DOCTYPE html>

<html lang="zh-tw">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>Linux kernel: Energy Aware scheduling (EAS) | Daichou&#39;s blog</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://daichou.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://daichou.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://daichou.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://daichou.github.io/manifest.json">
    <link rel="mask-icon" href="https://daichou.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://daichou.github.io/css/main.min.15431d6c334f65809fe2bc329da3f2c81c6e3027ab1e25b56afb2bb85fa7fd64.css"/>

    
    
    

    
    
 
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-161437179-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
</head>

    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://daichou.github.io/">Daichou&#39;s blog</a>
    </div>  
</header>

  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://daichou.github.io/">Posts</a>
  
    <a class="color-link nav-link" href="https://daichou.github.io/tags/">Tags</a>
  
    <a class="color-link nav-link" href="https://daichou.github.io/archives/">Archives</a>
  
    <a class="color-link nav-link" href="https://daichou.github.io/about/">About me</a>
  
  <a class="color-link nav-link" href="https://daichou.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        
    <a class="social-icon" href="mailto:tommy0705c@gmail.com" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <a class="social-icon" href="https://gattacangin.blogspot.com/" target="_blank" rel="noopener" title="Blogger">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M16.4225354,15.183099 C16.7605636,15.183099 17.0422536,15.3145545 17.2676055,15.5774654 C17.4929581,15.8028172 17.6056345,16.0845072 17.6056345,16.4225354 C17.6056345,16.7605636 17.4929581,17.0422536 17.2676055,17.2676055 C17.0422536,17.4929581 16.7605636,17.6056345 16.4225354,17.6056345 L11.5211272,17.6056345 C11.183099,17.6056345 10.9014088,17.4929581 10.6760564,17.2676055 C10.4507043,17.0422536 10.3380283,16.7605636 10.3380283,16.4225354 C10.3380283,16.0845072 10.4507043,15.8028172 10.6760564,15.5774654 C10.9014088,15.3145545 11.183099,15.183099 11.5211272,15.183099 L16.4225354,15.183099 Z M11.5211272,11.5774646 C11.183099,11.5774646 10.9014088,11.4647886 10.6760564,11.2394368 C10.4507043,11.0140849 10.3380283,10.7323948 10.3380283,10.3943664 C10.3380283,10.0563382 10.4507043,9.77464807 10.6760564,9.54929597 C10.9014088,9.3239438 11.183099,9.21126771 11.5211272,9.21126771 L14.6760568,9.21126771 C15.0140849,9.21126771 15.295775,9.3239438 15.5211268,9.54929597 C15.7464787,9.77464807 15.8591546,10.0563382 15.8591546,10.3943664 C15.8591546,10.7323948 15.7464787,11.0140849 15.5211268,11.2394368 C15.295775,11.4647886 15.0140849,11.5774646 14.6760568,11.5774646 L11.5211272,11.5774646 Z M18.7887323,11.5774646 L18.7887323,9.21126771 C18.7887323,8.23474189 18.431925,7.38967148 17.7183104,6.67605648 C17.004695,5.9624414 16.1596245,5.60563386 15.183099,5.60563386 L10.3943663,5.60563386 C9.41784045,5.60563386 8.57277003,5.9624414 7.85915503,6.67605648 C7.14553995,7.38967148 6.78873241,8.23474189 6.78873241,9.21126771 L6.78873241,17.6056345 C6.78873241,18.58216 7.14553995,19.4272304 7.85915503,20.1408458 C8.57277003,20.8544604 9.41784045,21.2112677 10.3943663,21.2112677 L17.6056345,21.2112677 C18.58216,21.2112677 19.4272304,20.8544604 20.1408458,20.1408458 C20.8544604,19.4272304 21.2112677,18.58216 21.2112677,17.6056345 L21.2112677,14 C21.2112677,13.6619718 21.0985918,13.3802818 20.8732399,13.1549299 C20.6478873,12.9295781 20.3661969,12.8169022 20.0281687,12.8169022 C19.6901405,12.8169022 19.3896714,12.7042258 19.1267613,12.4788732 C18.9014086,12.2159623 18.7887323,11.9154928 18.7887323,11.5774646 L18.7887323,11.5774646 Z M23.6338031,2 C24.2723005,2 24.8169014,2.24413145 25.2676059,2.73239436 C25.7558686,3.18309863 26,3.72769958 26,4.36619722 L26,23.6338031 C26,24.2723005 25.7558686,24.8356809 25.2676059,25.3239444 C24.8169014,25.7746481 24.2723005,26 23.6338031,26 L4.36619722,26 C3.7276995,26 3.16431919,25.7746481 2.67605628,25.3239444 C2.22535209,24.8356809 2,24.2723005 2,23.6338031 L2,4.36619722 C2,3.72769958 2.22535209,3.18309863 2.67605628,2.73239436 C3.16431919,2.24413145 3.7276995,2 4.36619722,2 L23.6338031,2 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://github.com/Daichou" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    <a class="social-icon" href="#ZgotmplZ" target="_blank" rel="noopener" title="Stack Overflow">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M20.8863636,23.7090909 L20.8863636,17.3818182 L22.9863636,17.3818182 L22.9863636,25.8090909 L4.03181818,25.8090909 L4.03181818,17.3818182 L6.13181818,17.3818182 L6.13181818,23.7090909 L20.8863636,23.7090909 Z M8.45,16.7818182 L8.88636364,14.7090909 L19.1954545,16.8636364 L18.7590909,18.9363636 L8.45,16.7818182 Z M9.81363636,11.8727273 L10.6863636,9.93636364 L20.2318182,14.4090909 L19.3590909,16.3181818 L9.81363636,11.8727273 Z M12.4590909,7.18181818 L13.7954545,5.57272727 L21.8954545,12.3090909 L20.5590909,13.9181818 L12.4590909,7.18181818 Z M17.6954545,2.19090909 L23.9681818,10.6454545 L22.2772727,11.9 L16.0045455,3.44545455 L17.6954545,2.19090909 Z M8.23181818,21.5818182 L8.23181818,19.4818182 L18.7590909,19.4818182 L18.7590909,21.5818182 L8.23181818,21.5818182 Z"></path>
        </svg>
    </a>
    
    
    

    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://daichou.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>
</nav>

        <div id="content" class="content-container">
        

<h1 class="post-title">Linux kernel: Energy Aware scheduling (EAS)</h1>
    
    <time>July 4, 2019</time>
    
    <div>
        <p>
        <h1 id="energy-aware-scheduling">Energy Aware scheduling</h1>

<p>之前寫的作業報告，我覺得可以分享出來<br>
hackmd版：<a href="https://hackmd.io/@Daichou/ByzK-S60E">https://hackmd.io/@Daichou/ByzK-S60E</a><br>
主要文章：<a href="https://www.linaro.org/blog/energy-aware-scheduling-eas-progress-update/">https://www.linaro.org/blog/energy-aware-scheduling-eas-progress-update/</a></p>

<h2 id="httpshackmdiopjpkxr6klirnvii1kwe8838ce699af-背景背景"><a href="https://hackmd.io/-PJ_Pkx_R6KliRnVii_1kw#%E8%83%8C%E6%99%AF" title="背景"></a>背景</h2>

<p>本文主要以linaro 於2015年提出之EAS(Energy aware scheduling)框架看當今Linux kernel 5.0以後從EAS與Android端整合回kernel的EAS與EM(energy model)。<br>
自從Arm big.LITTLE 從原本的硬體切換叢集大小核，到後來的HMP(heterogeneous multi-processing)，傳統Linux的SMP排程方式不敷使用，由於傳統Linux kernel的CFS(Completely Fair Scheduler)是以吞吐量(throughput)為主，對於移動平台的功耗掌控不甚理想。因此Arm與Linaro團隊提出了EAS作為對於HMP下Linux CFS,cpuidle,cpufreq子系統的加強。後來導入EM 框架，作為EAS與driver與其他Linux子系統，如：device tree與Thermal(目前仍未連接)的介面。</p>

<h2 id="httpshackmdiopjpkxr6klirnvii1kwenergymodelframework-energymodelframeworkenergy-model-framework"><a href="https://hackmd.io/-PJ_Pkx_R6KliRnVii_1kw#Energy-Model-Framework" title="Energy-Model-Framework"></a>Energy Model Framework</h2>

<h3 id="httpshackmdiopjpkxr6klirnvii1kwinterface-interfaceinterface"><a href="https://hackmd.io/-PJ_Pkx_R6KliRnVii_1kw#Interface" title="Interface"></a>Interface</h3>

<p>EM(energy model Framework)是Linux kernel特別抽出的介面，用來讓子系統或是driver可以透過em_register_perf_domain()函式註冊一個特別情況下的時脈與功耗的關係(performance domain)。<br>
<figure><img src="https://i.imgur.com/Jzt2M3w.png" alt=""></figure><br>
如上圖可見driver透過em_register_perf_domain註冊效能資料，Kernel透過em_pd_energy()取得功耗估計，而em_cpu_get()用以取得EM中的energy model table的資料。目前僅有Scheduler需要這些資料，不過Linux kernel預期會有更多子系統需要這些資料，因此將特別抽出建立一層抽象化。</p>

<h3 id="httpshackmdiopjpkxr6klirnvii1kwoppoperatingperformancepoints-oppoperatingperformancepointsoppoperating-performance-points"><a href="https://hackmd.io/-PJ_Pkx_R6KliRnVii_1kw#OPPoperating-performance-points" title="OPPoperating-performance-points"></a>OPP(operating performance points)</h3>

<p>由於當前SOC盛行，SOC有許多子模塊(例如：CPU cluster)，這些子模塊可以依照使用情境給予不同的頻率與電壓組合，並不一定需要整個SOC依照相同頻率運作，這些子模塊通常被分為domain，各domain可以有多組頻率與電壓組合被稱為operating performance points(OPP)。OPP透過device tree source(dts)由開發者建立，通常於開機時初始化。<br>
<figure><img src="https://www.linaro.org/assets/blog/EAS-image-11-f4a331f605b5adbd4d8330917f421070c2b0fc0e7d4fd2e22de1cbe2bf8e83c5.jpg" alt=""></figure><br>
(資料來源:<a href="https://www.linaro.org/assets/blog/EAS-image-11-f4a331f605b5adbd4d8330917f421070c2b0fc0e7d4fd2e22de1cbe2bf8e83c5.jpg">https://www.linaro.org/assets/blog/EAS-image-11-f4a331f605b5adbd4d8330917f421070c2b0fc0e7d4fd2e22de1cbe2bf8e83c5.jpg</a>)<br>
以上圖為例由於CPU的算力與功率是曲線而非直線，因此透過OPP可以增加EM推算未來功耗的準確度，這項設計可讓EM預測功耗的線性內插運算更為精準。</p>

<h3 id="httpshackmdiopjpkxr6klirnvii1kwperformancedomainperfdomain-performancedomainperfdomainperformance-domainperfdomain"><a href="https://hackmd.io/-PJ_Pkx_R6KliRnVii_1kw#Performance-domainperf_domain" title="Performance-domainperf_domain"></a>Performance domain(perf_domain)</h3>

<p><figure><img src="https://i.imgur.com/aFK71Nc.png" alt=""></figure><br>
整個performance domain結構如上圖。每個cpu run queue會指向一個root_domain（用以表達一個cpu set），每個root_domain會用linked list儲存多個perf_domain，每個performace domain中的CPU必須是相同的microarchitecture(例如均為Cortex-A53)且當調整一個perf_domain的物理參數(如電壓等)，整個perf_domain中的硬體均會一起被調整，每個perf_domain對應的em_perf_domain會透過em_register_perf_domain()與對應的callback function建立em_cap_state。以從device tree建立的方式為例，em_register_perf_domain()會透過OPP的_get_cpu_power()依照：</p>

<blockquote>
<p>Power = Capacity * Voltage^2 * frequency</p>
</blockquote>

<p>公式將OPP轉成mW、frequency以及cost組合存入em_cap_state，其中cost計算方式為:</p>

<blockquote>
<p>Cost = max_cpu_frequency * em_cap_state.power/em_cap_state.frequency</p>
</blockquote>

<p>perf_domain與root_domain對應到實際上的SOC的關係則是如下圖。通常一個root_domain對應到一個SOC，而perf_domain對應到其中的CPU cluster。如果cluster中的CPU可以特別調頻，則可以在拆分更多perf_domain。<br>
<figure><img src="https://i.imgur.com/YBMT8F1.png" alt=""></figure></p>

<h2 id="httpshackmdiopjpkxr6klirnvii1kwenergyawarescheduler-energyawareschedulerenergy-aware-scheduler"><a href="https://hackmd.io/-PJ_Pkx_R6KliRnVii_1kw#Energy-Aware-Scheduler" title="Energy-Aware-Scheduler"></a>Energy Aware Scheduler</h2>

<p>EAS 基本上並非完全提出一個新的scheduler，而是在更改現有scheduler(CFS)在挑選指派cpu的方式。藉此調整HMP的功耗。</p>

<h3 id="httpshackmdiopjpkxr6klirnvii1kwcpucapacity-cpucapacitycpu-capacity"><a href="https://hackmd.io/-PJ_Pkx_R6KliRnVii_1kw#CPU-capacity" title="CPU-capacity"></a>CPU capacity</h3>

<p>CPU capacity是用以表達當CPU以最高頻率運行時的throughput。透過CPU capacity與scheduler 從Per-Entity Load Tracking(PELT)取得task運作數據了解該CPU的忙碌程度。CPU capacity是開機時在建立CPU topology時解析device tree建立。系統可以透過arch_scale_cpu_capacity()讀取該值。</p>

<h3 id="httpshackmdiopjpkxr6klirnvii1kwpolicy-policypolicy"><a href="https://hackmd.io/-PJ_Pkx_R6KliRnVii_1kw#policy" title="policy"></a>policy</h3>

<p>Energy aware scheduling透過選取CPU的方式，主要透過select_task_rq_fair這個函式將任務發配給cpu runqueue。而整個scheduler有兩個情境會需要執行此函式:</p>

<ol>
<li>execve -&gt; sched_exec</li>
<li>wake up一個task</li>
</ol>

<h4 id="httpshackmdiopjpkxr6klirnvii1kwtaske79a84e883bde88097e9a090e6b8ac-task的能耗預測task的能耗預測"><a href="https://hackmd.io/-PJ_Pkx_R6KliRnVii_1kw#task%E7%9A%84%E8%83%BD%E8%80%97%E9%A0%90%E6%B8%AC" title="task的能耗預測"></a>task的能耗預測</h4>

<p>透過Energy Model提供的em_pd_energy()預測，推算方式如下:
<span  class="math">\(
cs ： domain\ capacity\ state
\)</span></p>

<p>透過頻率與CPU utilization的關係我們可以找到大於當前CPU uilization最小的cs。</p>

<p><span  class="math">\(
cs\ capacity = {CPU\ max\ capacity} * \dfrac{cs\ frequency}{CPU\ max\  frequency}\\\\ 
\)</span>
<span  class="math">\(
\\Predict\ CPU\ energy = cpu\ utilization *\dfrac{cs\ power}{cs\ capacity} ...(1)\\
\)</span>
<span  class="math">\(
= \dfrac{cs\ power * CPU\ max\ freq}{cs\ frequency} * \dfrac {CPU\ utilization}{CPU\ max\ capacity} ...(2)
\)</span></p>

<p>由於<br>
<span  class="math">\(
\dfrac{cs\ power * CPU\ max\ freq}{cs\ frequency} = cs\ cost(em\_cap\_state.cost)
\)</span></p>

<p>所以<br>
<span  class="math">\(
Predict\ CPU\ energy =\dfrac{CPU\ utilization * cs\ cost}{CPU\ max\ capacity}
\)</span></p>

<p>Linux kernel中使用化約過的(2)式做運算，而我們以下範例使用直觀的(1)式。範例:<figure><img src="https://i.imgur.com/vgeJiuA.png" alt=""></figure><br>
當前狀況CPU01為同perf_domain，CPU23為同perf_domain，若P1(平均util=200):</p>
<pre><code>CPU0: 400 / 512 * 300 = 234  
CPU1: 100 / 512 * 300 = 58  
CPU2: 600 / 768 * 800 = 625  
CPU3: 500 / 768 * 800 = 520  
共1437  </code></pre>
<p>若P1移到CPU1</p>
<pre><code>CPU0: 200 / 341 * 150 = 88  
CPU1: 300 / 341 * 150 = 131  
CPU2: 600 / 768 * 800 = 625  
CPU3: 500 / 768 * 800 = 520  
共1364  </code></pre>
<p>若P1移到CPU3(無法移到2除非調整OPP)</p>
<pre><code>CPU0: 200 / 341 * 150 = 88  
CPU1: 100 / 341 * 150 = 43  
CPU2: 600 / 768 * 800 = 625  
CPU3: 700 / 768 * 800 = 729  
共1485  </code></pre>
<p>透過此方式可知將task放到CPU1有最佳功耗。</p>

<h4 id="httpshackmdiopjpkxr6klirnvii1kwease69982e99693e8a487e99b9ce5baa6-eas時間複雜度eas-時間複雜度"><a href="https://hackmd.io/-PJ_Pkx_R6KliRnVii_1kw#EAS-%E6%99%82%E9%96%93%E8%A4%87%E9%9B%9C%E5%BA%A6" title="EAS-時間複雜度"></a>EAS 時間複雜度</h4>

<p>由上的運算可知每次運算(select_task_rq_fair)需要遍歷root_domain下所有的perf_domain，並且需要計算每個CPU與其OPP是落在哪個效能區間，依照kernel文件給出的時間複雜度如下：</p>

<p><span  class="math">\[Complexity = Nd * (Nc + Ns)\\
Nd: Number\ of\ performance\ domain\\
Nc: Number\ of\ CPUS\\
Ns: total\ number\ of\ OPPS\\
(ex:\ if\ 2\ perf\ domain\ with\ 4\ OPPs\ each,\ Ns\ =\ 8)\]</span></p>

<p>此對於task wake up的情況來說，此情況對於時間複雜度很敏感，如果EAS(EM)複雜度過高會導致OS反應不佳，因此EM設立了EM_MAX_COMPLEXITY門檻(預設2048)，若Complexity數值高過此數值則不啟用EAS，一般開發人員也可以透過：</p>

<ol>
<li>分隔root_domain減少domain中的CPU數量降低複雜度</li>
<li>減少EAS task wake up的複雜度(需要自己上patch)，不過難度很高</li>
</ol>

<p>來減少task wake-up的延遲。</p>

<h4 id="httpshackmdiopjpkxr6klirnvii1kwease68890e7ab8be58187e8a8ad-eas成立假設eas成立假設"><a href="https://hackmd.io/-PJ_Pkx_R6KliRnVii_1kw#EAS%E6%88%90%E7%AB%8B%E5%81%87%E8%A8%AD" title="EAS成立假設"></a>EAS成立假設</h4>

<p>EAS要能夠成功在不影響效能運作，且達成能耗最佳化必須建立在以下三個假設：</p>

<ol>
<li>所有CPU都有足夠的idle時間：確保task可以不受效能限制的運行，使PELT計量的task utilization為正確的。</li>
<li>每個task都被供給足夠的CPU capacity:原因同上。</li>
<li>每個CPU都有足夠的剩餘capacity，以滿足task wake-up且task的blocking/sleeping愈規律愈好</li>
</ol>

<p>這些假設必須在CPU低於80% capacity情況下才可以成立，當高於此值稱為over-utilization，此狀況下EAS的會無法得到足夠的選擇，導致效能損失。</p>

<h3 id="httpshackmdiopjpkxr6klirnvii1kwoverutilization-overutilizationoverutilization"><a href="https://hackmd.io/-PJ_Pkx_R6KliRnVii_1kw#Over-utilization" title="Over-utilization"></a>Over-utilization</h3>

<p>為了確保EAS不要在效能吃緊時影響效能，EAS建立了一個狀態 “over-utilization” 。當CPU使用了超過 80% 的capacity時，SG_OVERUTILIZED這個flag會被設立，這時scheduler會放棄使用EAS的指派CPU機制，而改用原先CFS的指派方式:選擇同一schedule domain下負載最小的CPU(最idle的CPU)或是相鄰schedule domain下覆載最小的CPU。<br>
此機制的檢查是在:<br>
1.透過SCHED_SOFRIRQ發生時，透過update_sg_lb_stats()檢查並更新sched_group的統計數據<br>
2.新的task被放入CFS的紅黑樹時檢查。</p>

<h3 id="httpshackmdiopjpkxr6klirnvii1kwloadbalance-loadbalanceload-balance"><a href="https://hackmd.io/-PJ_Pkx_R6KliRnVii_1kw#load-balance" title="load-balance"></a>load balance</h3>

<p>Linux kernel 透過SCHED_SOFTIRQ這個softirq對應的action函式驅動scheduler檢查是否需要進行load balance，然而在EAS啟動時(sched_energy_enabled()回傳值為真)情況下，會直接將當前情況視為沒有負載不均衡(find_busiedt_group()會清除imbalance flag並回傳NULL)。因為EAS很容易造成大小核任務分配不均的情況。然而只要root domain中其中個CPU發生over-utilization的情況，即便EAS啟動，load balance仍會進行。</p>

<h3 id="httpshackmdiopjpkxr6klirnvii1kwdependency-dependencydependency"><a href="https://hackmd.io/-PJ_Pkx_R6KliRnVii_1kw#Dependency" title="Dependency"></a>Dependency</h3>

<p>EAS需要以下滿足以下相依性：</p>

<ol>
<li>非對稱CPU架構(即SD_ASYM_CPUCAPACITY flag必須開啟)，Ex: big.LITTLE架構。</li>
<li>Energy model:用來提供效能參數。</li>
<li>EM複雜度低於門檻。</li>
<li>Schedutil governor：為Linux 4.7以後新增的governor，用以動態根據utilization調節CPU freqency，EAS只能使用這個governor。</li>
<li>Scale-invariant utilization signals：PELT必須能夠給出frequency-invariant and CPU-invariant PELT訊號以給出正確的功耗預測。</li>
</ol>

<p>綜合5.與6.由於必須要提供frequency-invariant訊號，因此系統的util必須是frequency-invariant。因此在Schedutil governor中使用:</p>

<p><span  class="math">\[next\_freq\ =\ 1.25\ *\ max\_freq\ *\ \frac{ utilization} {max\_cpu\_capacity}\]</span></p>

<p>作為調整公式(若為variant，max_freq項需替換成cur_freq)。當CFS的run queue中的utilization改變時會觸發cpufreq_update_util()，由於在EAS情況下會使用SchedUtil governor，會對應到sugov_update_single()或是sugov_update_shared()進行頻率更新。</p>

<blockquote>
<p>在linaro文章中提到的是cpufreq governor，其已經被SchedUtil governor正式取代。</p>
</blockquote>

<h3 id="httpshackmdiopjpkxr6klirnvii1kwe69588e883bde695b8e6939a-效能數據效能數據"><a href="https://hackmd.io/-PJ_Pkx_R6KliRnVii_1kw#%E6%95%88%E8%83%BD%E6%95%B8%E6%93%9A" title="效能數據"></a>效能數據</h3>

<p>可以發現負載愈小節能效果愈好，因為task可以指派的選項比較多，可以找到更好的結果。但是EAS仍會造成一些效能損失。<br>
<figure><img src="https://community.arm.com/resized-image/__size/1040x440/__key/communityserver-blogs-components-weblogfiles/00-00-00-21-42/5824.blog_5F00_eas_5F00_comparison.png" alt="image alt"></figure><br>
資料來源:ARM</p>

<h2 id="httpshackmdiopjpkxr6klirnvii1kwe69caae4be86e799bce5b195-未來發展未來發展"><a href="https://hackmd.io/-PJ_Pkx_R6KliRnVii_1kw#%E6%9C%AA%E4%BE%86%E7%99%BC%E5%B1%95" title="未來發展"></a>未來發展</h2>

<p>1.EM是否該包含GPU等其他運算單元。</p>

<blockquote>
<p>目前移動裝置中仍未出現異質的GPU設計，所以仍未限包含GPU的需求</p>
</blockquote>

<p>2.是否有其他子系統需要EM的參數。</p>

<h2 id="httpshackmdiopjpkxr6klirnvii1kwe585b6e4bb96e8b387e69699-其他資料其他資料"><a href="https://hackmd.io/-PJ_Pkx_R6KliRnVii_1kw#%E5%85%B6%E4%BB%96%E8%B3%87%E6%96%99" title="其他資料"></a>其他資料</h2>

<ul>
<li>Linux kernel 5.1.7</li>
<li><a href="https://community.arm.com/developer/ip-products/processors/b/processors-ip-blog/posts/energy-aware-scheduling-in-linux?_ga=2.147868471.1685157891.1560397806-813229620.1550324550">https://community.arm.com/developer/ip-products/processors/b/processors-ip-blog/posts/energy-aware-scheduling-in-linux?_ga=2.147868471.1685157891.1560397806-813229620.1550324550</a></li>
<li>SchedUtil

<ul>
<li><a href="https://lkml.org/lkml/2016/3/29/1041">https://lkml.org/lkml/2016/3/29/1041</a></li>
<li><a href="https://lwn.net/Articles/682391/">https://lwn.net/Articles/682391/</a></li>
</ul></li>
</ul>

        </p>
    </div>
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "daichou-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://daichou.github.io/tags/linux">#Linux</a>
        
      
    </div>


        

<link rel="stylesheet" type="text/css" href="https://daichou.github.io/css/katex.min.css" crossorigin="anonymous">
<script type="text/javascript" src="https://daichou.github.io/js/katex.min.js" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://daichou.github.io/js/auto-render.min.js"onload="renderMathInElement(document.body);" crossorigin="anonymous"></script>

        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        
    <a class="social-icon" href="mailto:tommy0705c@gmail.com" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <a class="social-icon" href="https://gattacangin.blogspot.com/" target="_blank" rel="noopener" title="Blogger">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M16.4225354,15.183099 C16.7605636,15.183099 17.0422536,15.3145545 17.2676055,15.5774654 C17.4929581,15.8028172 17.6056345,16.0845072 17.6056345,16.4225354 C17.6056345,16.7605636 17.4929581,17.0422536 17.2676055,17.2676055 C17.0422536,17.4929581 16.7605636,17.6056345 16.4225354,17.6056345 L11.5211272,17.6056345 C11.183099,17.6056345 10.9014088,17.4929581 10.6760564,17.2676055 C10.4507043,17.0422536 10.3380283,16.7605636 10.3380283,16.4225354 C10.3380283,16.0845072 10.4507043,15.8028172 10.6760564,15.5774654 C10.9014088,15.3145545 11.183099,15.183099 11.5211272,15.183099 L16.4225354,15.183099 Z M11.5211272,11.5774646 C11.183099,11.5774646 10.9014088,11.4647886 10.6760564,11.2394368 C10.4507043,11.0140849 10.3380283,10.7323948 10.3380283,10.3943664 C10.3380283,10.0563382 10.4507043,9.77464807 10.6760564,9.54929597 C10.9014088,9.3239438 11.183099,9.21126771 11.5211272,9.21126771 L14.6760568,9.21126771 C15.0140849,9.21126771 15.295775,9.3239438 15.5211268,9.54929597 C15.7464787,9.77464807 15.8591546,10.0563382 15.8591546,10.3943664 C15.8591546,10.7323948 15.7464787,11.0140849 15.5211268,11.2394368 C15.295775,11.4647886 15.0140849,11.5774646 14.6760568,11.5774646 L11.5211272,11.5774646 Z M18.7887323,11.5774646 L18.7887323,9.21126771 C18.7887323,8.23474189 18.431925,7.38967148 17.7183104,6.67605648 C17.004695,5.9624414 16.1596245,5.60563386 15.183099,5.60563386 L10.3943663,5.60563386 C9.41784045,5.60563386 8.57277003,5.9624414 7.85915503,6.67605648 C7.14553995,7.38967148 6.78873241,8.23474189 6.78873241,9.21126771 L6.78873241,17.6056345 C6.78873241,18.58216 7.14553995,19.4272304 7.85915503,20.1408458 C8.57277003,20.8544604 9.41784045,21.2112677 10.3943663,21.2112677 L17.6056345,21.2112677 C18.58216,21.2112677 19.4272304,20.8544604 20.1408458,20.1408458 C20.8544604,19.4272304 21.2112677,18.58216 21.2112677,17.6056345 L21.2112677,14 C21.2112677,13.6619718 21.0985918,13.3802818 20.8732399,13.1549299 C20.6478873,12.9295781 20.3661969,12.8169022 20.0281687,12.8169022 C19.6901405,12.8169022 19.3896714,12.7042258 19.1267613,12.4788732 C18.9014086,12.2159623 18.7887323,11.9154928 18.7887323,11.5774646 L18.7887323,11.5774646 Z M23.6338031,2 C24.2723005,2 24.8169014,2.24413145 25.2676059,2.73239436 C25.7558686,3.18309863 26,3.72769958 26,4.36619722 L26,23.6338031 C26,24.2723005 25.7558686,24.8356809 25.2676059,25.3239444 C24.8169014,25.7746481 24.2723005,26 23.6338031,26 L4.36619722,26 C3.7276995,26 3.16431919,25.7746481 2.67605628,25.3239444 C2.22535209,24.8356809 2,24.2723005 2,23.6338031 L2,4.36619722 C2,3.72769958 2.22535209,3.18309863 2.67605628,2.73239436 C3.16431919,2.24413145 3.7276995,2 4.36619722,2 L23.6338031,2 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://github.com/Daichou" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    <a class="social-icon" href="#ZgotmplZ" target="_blank" rel="noopener" title="Stack Overflow">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M20.8863636,23.7090909 L20.8863636,17.3818182 L22.9863636,17.3818182 L22.9863636,25.8090909 L4.03181818,25.8090909 L4.03181818,17.3818182 L6.13181818,17.3818182 L6.13181818,23.7090909 L20.8863636,23.7090909 Z M8.45,16.7818182 L8.88636364,14.7090909 L19.1954545,16.8636364 L18.7590909,18.9363636 L8.45,16.7818182 Z M9.81363636,11.8727273 L10.6863636,9.93636364 L20.2318182,14.4090909 L19.3590909,16.3181818 L9.81363636,11.8727273 Z M12.4590909,7.18181818 L13.7954545,5.57272727 L21.8954545,12.3090909 L20.5590909,13.9181818 L12.4590909,7.18181818 Z M17.6954545,2.19090909 L23.9681818,10.6454545 L22.2772727,11.9 L16.0045455,3.44545455 L17.6954545,2.19090909 Z M8.23181818,21.5818182 L8.23181818,19.4818182 L18.7590909,19.4818182 L18.7590909,21.5818182 L8.23181818,21.5818182 Z"></path>
        </svg>
    </a>
    
    
    

    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://daichou.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>
    </body>
</html>