<!DOCTYPE html>

<html lang="zh-tw">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>gattaca-ngin</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://daichou.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-161437179-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="/">gattaca-ngin</a>
    </div>  
</header>
  <div class="nav-menu">
  
  <a class="color-link nav-link" href="https://daichou.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://daichou.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">使用LXC建立USB以及X-forward環境(deprecated)</h1>
    
    <time>March 9, 2018</time>
    
    <div>
        <p>
        <h1 id="使用lxc建立usb以及x-forward環境deprecated">使用LXC建立USB以及X forward環境(deprecated)</h1>
<p>因為修課需要一些debian系的工具，不過我不想讓debian系的和Arch Linux混在一起，所以LXC看起來是一個不錯的解。</p>
<h3 id="環境">環境</h3>
<ol>
<li>OS: Arch Linux (4.15.7-1-ARCH)</li>
<li>LXC</li>
<li>ubuntu on LXC</li>
</ol>
<h2 id="步驟">步驟</h2>
<h3 id="lxc準備">LXC準備</h3>
<h4 id="安裝-lxc">安裝 LXC</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ sudo pacman -Sy lxc arch-install-scripts debootstap  

</code></pre></div><h4 id="建立-host-network-nat-bridge-arch-wiki寫得很好看arch-wiki">建立 Host Network (NAT bridge) (Arch Wiki寫得很好看Arch Wiki)</h4>
<p>建立/etc/default/lxc-net(詳情見Arch Wiki)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">USE_LXC_BRIDGE=&#34;true&#34;  
LXC_BRIDGE=&#34;lxcbr0&#34;  
LXC_ADDR=&#34;10.0.3.1&#34;  
LXC_NETMASK=&#34;255.255.255.0&#34;  
LXC_NETWORK=&#34;10.0.3.0/24&#34;  
LXC_DHCP_RANGE=&#34;10.0.3.2,10.0.3.254&#34;  
LXC_DHCP_MAX=&#34;253&#34;  

</code></pre></div><p>修改lxc template conf，在/etc/lxc/default.conf新增</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">lxc.net.0.type = veth  
lxc.net.0.link = lxcbr0  
lxc.net.0.flags = up  
lxc.net.0.hwaddr = 00:16:3e:xx:xx:xx  

</code></pre></div><p>安裝dnsmasq</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ sudo pacman -Sy dnsmasq  

</code></pre></div><p>開啟以及設定開機啟動：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">sudo systemctl start lxc-net  
sudo systemctl enable lxc-net  
</code></pre></div><h3 id="建立container-ubuntu">建立container (ubuntu)</h3>
<p>建previleged的container</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ sudo lxc-create -n UbuntuBuild -t /usr/share/lxc/templates/lxc-ubuntu <span style="color:#f92672">[</span> -P lxc-location<span style="color:#f92672">]</span>    
</code></pre></div><p>修改container的網路(由於我要裝的軟體的license綁mac address，所以我需要修改一下mac address)，修改lxc的路徑下的config file，若沒指定lxc的位置，預設是在/var/lib/lxc/CONTAINER_NAME/config，有指定路徑則在 /PATH/YOU/DEFINED/CONTAINER_NAME/config</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">## default values  
...   
...  
## network  
lxc.net.0.type = veth  
lxc.net.0.link = br0  
lxc.net.0.flags = up  
lxc.net.0.name = eth0  
lxc.net.0.hwaddr = .... ## 自行修改mac address  

</code></pre></div><h3 id="lxc-xorg">LXC Xorg</h3>
<p>修改container的config(同上位置)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">## default values  
...  
...  
# network  
...  
...  
## for xorg  
lxc.mount.entry = /dev/dri dev/dri none bind,optional,create=dir  
lxc.mount.entry = /dev/snd dev/snd none bind,optional,create=dir  
lxc.mount.entry = /tmp/.X11-unix tmp/.X11-unix none bind,optional,create=dir,ro  
lxc.mount.entry = /dev/video0 dev/video0 none bind,optional,create=file  
  
lxc.mount.entry = tmpfs tmp tmpfs defaults  

</code></pre></div><p>基本上邏輯是把Xorg需要的device mount進來。<br>
/dev/dri為direct rendering manager(DRM)的device file，<br>
/dev/snd為音效的device file<br>
/dev/video0為video device file</p>
<h5 id="ubuntu-on-lxc中安裝x相關套件">ubuntu on LXC中安裝X相關套件</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ sudo lxc-console -n UbuntuBuild <span style="color:#f92672">[</span> -P /path<span style="color:#f92672">]</span>  

</code></pre></div><p>進到ubuntu lxc</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># sudo apt-get install xauth x11-apps</span>  

</code></pre></div><p>使用ssh -X進入LXC</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># /usr/bin/xclock</span>  
</code></pre></div><p>應該要有windows跑出來<br>
其他app可能會需要裝dbus</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># sudo apt-get install dbus dbus-x11</span>  
</code></pre></div><p>其他部份可以看以連結<a href="https://newspaint.wordpress.com/2015/09/14/how-do-i-get-x11-applications-running-in-a-lxc-container/">How Do I Get X11 Applications Running in a LXC Container?</a></p>
<h3 id="lxc-usb">LXC USB</h3>
<p>修改container的config(同上位置)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">## usb  
lxc.cgroup.devices.allow = c 189:* rwm  
  
lxc.mount.entry = /dev/bus/usb/001 dev/bus/usb/001  none bind,optional,create=dir  
lxc.mount.entry = /dev/bus/usb/002 dev/bus/usb/002  none bind,optional,create=dir  
lxc.mount.entry = /dev/bus/usb/003 dev/bus/usb/003  none bind,optional,create=dir  
lxc.mount.entry = /dev/bus/usb/004 dev/bus/usb/004  none bind,optional,create=dir  

</code></pre></div><p>接下來我們來探究一下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">lxc.cgroup.devices.allow = c 189:* rwm  

</code></pre></div><p>這行的意思，首先</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">$ ls -al /dev/bus/usb/001  
drwxr-xr-x 2 root root     80 Mar  8 23:06 .  
drwxr-xr-x 6 root root    120 Mar  8 23:06 ..  
crw-rw-r-- 1 root root 189, 0 Mar  8 23:06 001  
crw-rw-r-- 1 root root 189, 1 Mar  8 23:06 002  
</code></pre></div><p>你會發現189這個數字，這數字其實是major number，這些數字在Linux的文件中都有定義，請看https://github.com/torvalds/linux/blob/master/Documentation/admin-guide/devices.txt<br>
逗號後為minor number，有於usb裝置多，所以在lxc.cgroup.devices.allow中用wildcard取代。底下部份就是把usb的device folder mount進LXC中。</p>
<h3 id="lxc-serial-port設定">LXC Serial Port設定</h3>
<p>由於修課需要用到serial port，但是Serial Port的tty只有插上後才會出現，這對開機就需mount的lxc來說偏麻煩。這時有一個好用的指令出現了。</p>
<h4 id="lxc-device">lxc-device</h4>
<p>在使用lxc-device時仍須注意cgroup是否有允許該裝置。<br>
例如Serial Port常用(USB serial converters)的major number為188。所以需要在config中新增</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">lxc.cgroup.devices.allow = c 188:* rwm  
</code></pre></div><p>這樣開機後才有效果。接下來，在插入裝置後找到該裝置device名稱，例如<br>
/dev/ttyUSB1。這時我們需要透過lxc-device把其接入中。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ sudo lxc-device -n CONTAINER_NAME<span style="color:#ae81ff">\[</span>-P path<span style="color:#f92672">]</span> add /dev/ttyUSB1  
</code></pre></div><p>這樣這個裝置就會被加入LXC中了。</p>

        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="/tags/note">#Note</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://daichou.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>