<!DOCTYPE html>

<html lang="zh-tw">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>gattaca-ngin</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://daichou.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-161437179-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="/">gattaca-ngin</a>
    </div>  
</header>
  <div class="nav-menu">
  
  <a class="color-link nav-link" href="https://daichou.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://daichou.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">使用Vivado Xilinx AXI verification IP進行AXI ip開發驗證</h1>
    
    <time>March 22, 2020</time>
    
    <div>
        <p>
        <h2 id="xilinx-axi-verification-ip-tutorial">Xilinx AXI Verification IP tutorial</h2>
<h4 id="前情提要">前情提要</h4>
<p>一般來說開發Xilinx FPGA上的AXI master/slave ip都是透過C/C++ 轉成HLS或是直接撰寫Verilog。透過C/C++ 轉成的HLS可以自己寫簡單的C/C++ 程式作為testbench，驗證結果可以直接看C/C++ testbench的結果而定，Verilog細節、AXI操作等問題Vivado HLS會幫你完全處理(如果這些部份出現問題，你也沒輒了)。但是透過Verilog直接寫成的IP，通常需要CPU還有記憶體界面(eg. mig)之類的進行全系統測試，而獲取波形等資訊需要透過合成ILA在板子上實際測試。這流程十分繁瑣，合成ILA會浪費大量syntesis和implementation時間，而且可以debug的的訊號數量受限於晶片上的block ram以及LUT數量。然而很多人忽略了Xilinx其實提供了AXI verification IP，可以簡單快速撰寫testbench直接進行behavior simulation，這對於縮短演算法邏輯開發的時間有益。</p>
<p>本文主要以 CPU &lt;-&gt; AXI slave &lt;=&gt; AXI master &lt;-&gt; memory此模式為主。</p>
<p>完整文件請看<a href="https://www.xilinx.com/support/documentation/ip_documentation/axi_vip/v1_0/pg267-axi-vip.pdf">AXI Verification IP v1.0</a>。</p>
<h4 id="axi-verification-ip-簡介">AXI Verification IP 簡介</h4>
<p>Xilinx AXI Verification IP主要提供的功能為:</p>
<ul>
<li> 產生AXI master command與資料(可自訂)</li>
<li>產生AXI slave進行資料讀取與回覆(也可以模擬mig記憶體界面)</li>
<li>檢查AXI protocol</li>
</ul>
<p>而Xilinx AXI Verification IP (VIP)主要有三種模式：</p>
<ul>
<li>
<p>作為AXI master</p>
</li>
<li>
<p>用來測試AXI slave ip</p>
</li>
<li>
<p>作為AXI slave</p>
</li>
<li>
<p>用來測試AXI master ip</p>
</li>
<li>
<p>作為AXI pass-through </p>
</li>
<li>
<p>(檢查兩個AXI IP之間的通訊)</p>
</li>
</ul>
<p>AXI VIP提供SystemVerilog界面，透過SystemVerilog的OOP包裝一些AXI protocol操作與memory model。讓開發者可以專注在測試策略上。</p>
<h4 id="flow">flow</h4>
<p>tools -&gt; create and Package New IP -&gt; choose Create AXI Peripheral<br>
其他創造ip都按照基本流程。</p>
<p><a href="https://1.bp.blogspot.com/-UjdXcXQCaVE/XncwUQzPWFI/AAAAAAAAHZo/hxdOA8Q_4KcWvI0NKNeqEHhMqBrO0YXvgCLcBGAsYHQ/s1600/DeepinScreenshot_select-area_20200317222544.png"><img src="https://1.bp.blogspot.com/-UjdXcXQCaVE/XncwUQzPWFI/AAAAAAAAHZo/hxdOA8Q_4KcWvI0NKNeqEHhMqBrO0YXvgCLcBGAsYHQ/s640/DeepinScreenshot_select-area_20200317222544.png" alt=""></a></p>
<p><a href="https://1.bp.blogspot.com/-YZceCPw5bsU/XncwUkrt2MI/AAAAAAAAHZs/y8lDIReFk-kbp8MyytGzv8xE5nWQnWYpQCLcBGAsYHQ/s1600/DeepinScreenshot_select-area_20200317222614.png"><img src="https://1.bp.blogspot.com/-YZceCPw5bsU/XncwUkrt2MI/AAAAAAAAHZs/y8lDIReFk-kbp8MyytGzv8xE5nWQnWYpQCLcBGAsYHQ/s640/DeepinScreenshot_select-area_20200317222614.png" alt=""></a></p>
<p><a href="https://1.bp.blogspot.com/-qQGFGJNgCpI/XncwUXEWH9I/AAAAAAAAHZk/nB8nsICwNq8MiE58grov7_rvF5FAXyI1QCLcBGAsYHQ/s1600/DeepinScreenshot_select-area_20200317222629.png"><img src="https://1.bp.blogspot.com/-qQGFGJNgCpI/XncwUXEWH9I/AAAAAAAAHZk/nB8nsICwNq8MiE58grov7_rvF5FAXyI1QCLcBGAsYHQ/s640/DeepinScreenshot_select-area_20200317222629.png" alt=""></a></p>
<p>這邊可以選取Verify Peripheral IP using AXI4 VIP，會建構完整的測試template。</p>
<p><a href="https://1.bp.blogspot.com/-OMqY5LP3wwA/XncwVE3fMBI/AAAAAAAAHZw/ALyC3KU7N9cuI5_I-ow2MYZRFHP3MuptwCLcBGAsYHQ/s1600/DeepinScreenshot_select-area_20200317222648.png"><img src="https://1.bp.blogspot.com/-OMqY5LP3wwA/XncwVE3fMBI/AAAAAAAAHZw/ALyC3KU7N9cuI5_I-ow2MYZRFHP3MuptwCLcBGAsYHQ/s640/DeepinScreenshot_select-area_20200317222648.png" alt=""></a></p>
<p>完成後會產生如下block diagram</p>
<p><a href="https://1.bp.blogspot.com/-MZp2HKmVa70/XncwfFkLuCI/AAAAAAAAHZ0/Yo-2q44Dw00e27fycWn_IC9geJbDul5kACLcBGAsYHQ/s1600/DeepinScreenshot_select-area_20200319173604.png"><img src="https://1.bp.blogspot.com/-MZp2HKmVa70/XncwfFkLuCI/AAAAAAAAHZ0/Yo-2q44Dw00e27fycWn_IC9geJbDul5kACLcBGAsYHQ/s640/DeepinScreenshot_select-area_20200319173604.png" alt=""></a></p>
<p>並且產生以下範例testbench，註解為程式區段用途。</p>
<pre><code>\`timescale 1ns / 1ps  
\`include &quot;my\_dma\_v1\_0\_tb\_include.svh&quot;  
// 以下為必要package  
import axi\_vip\_pkg::\*;  
import my\_dma\_v1\_0\_bfm\_1\_slave\_0\_0\_pkg::\*;  
import my\_dma\_v1\_0\_bfm\_1\_master\_0\_0\_pkg::\*;  
  
module my\_dma\_v1\_0\_tb();  
  
// AXI slave VIP 參數宣告(以下省略部份程式碼)  
xil\_axi\_uint                            error\_cnt = 0;  
xil\_axi\_uint                            comparison\_cnt = 0;  
axi\_transaction                         wr\_transaction;     
.......  
xil\_axi\_uint                           mst\_agent\_verbosity = 0;    
xil\_axi\_uint                           slv\_agent\_verbosity = 0;    
// AXI Slave VIP with memory model (如果你的ip為AXI master full會自動產生對應VIP)  
my\_dma\_v1\_0\_bfm\_1\_slave\_0\_0\_slv\_mem\_t          slv\_agent\_0;  
  
integer result\_slave;    
bit \[31:0\] S00\_AXI\_test\_data\[3:0\];   
 localparam LC\_AXI\_BURST\_LENGTH = 8;   
 localparam LC\_AXI\_DATA\_WIDTH = 32;   
  
// AXI master VIP 參數參數宣告  
integer                                 i;   
integer                                 j;    
xil\_axi\_uint                            trans\_cnt\_before\_switch = 48;    
xil\_axi\_uint                            passthrough\_cmd\_switch\_cnt = 0;    
......  
axi\_ready\_gen                           arready\_gen2;    
xil\_axi\_payload\_byte                    data\_mem\[xil\_axi\_ulong\];    
//AXI master VIP  
my\_dma\_v1\_0\_bfm\_1\_master\_0\_0\_mst\_t          mst\_agent\_0;  
// Design under test  
  \`BD\_WRAPPER DUT(  
      .ARESETN(reset),   
      .ACLK(clock)   
    );   
    
initial begin  
    //基本AXI VIP agent初始設定  
 slv\_agent\_0 = new(&quot;slave vip agent&quot;,DUT.\`BD\_INST\_NAME.slave\_0.inst.IF);  
       slv\_agent\_0.set\_agent\_tag(&quot;Slave VIP&quot;);  
    slv\_agent\_0.set\_verbosity(slv\_agent\_verbosity);  
    slv\_agent\_0.start\_slave();  
    mst\_agent\_0 = new(&quot;master vip agent&quot;,DUT.\`BD\_INST\_NAME.master\_0.inst.IF);//ms    
        mst\_agent\_0.set\_agent\_tag(&quot;Master VIP&quot;);   
    mst\_agent\_0.set\_verbosity(mst\_agent\_verbosity);   
    mst\_agent\_0.start\_master();   
     $timeformat (-12, 1, &quot; ps&quot;, 1);  
  end  
  initial begin  
    reset &lt;= 1'b0;  
    #100ns;  
    reset &lt;= 1'b1;  
    repeat (5) @(negedge clock);   
  end  
  always #5 clock &lt;= ~clock;  
  initial begin  
      S\_AXI\_TEST ( );  
  
    init\_0 = 0;  
    #200ns;  
    init\_0 =1'b1;  
    #20ns;  
    init\_0 = 1'b0;  
      
      #1ns;  
      $finish;  
  end  
  initial begin  
  #1;  
    forever begin  
      slv\_agent\_0.monitor.item\_collected\_port.get(slv\_monitor\_transaction);  
      slave\_moniter\_transaction\_queue.push\_back(slv\_monitor\_transaction);  
      slave\_moniter\_transaction\_queue\_size++;  
    end  
  end  
//測試task範例  
task automatic S\_AXI\_TEST;    
begin     
#1;   
   $display(&quot;Sequential write transfers example similar to  AXI BFM WRITE\_BURST method starts&quot;);   
   mtestID = 0;   
   mtestADDR = 64'h00000000;   
   mtestBurstLength = 0;   
   mtestDataSize = xil\_axi\_size\_t'(xil\_clog2(32/8));   
   mtestBurstType = XIL\_AXI\_BURST\_TYPE\_INCR;    
   mtestLOCK = XIL\_AXI\_ALOCK\_NOLOCK;    
   mtestCacheType = 0;    
   mtestProtectionType = 0;    
   mtestRegion = 0;   
   mtestQOS = 0;   
   result\_slave = 1;   
  mtestWDataL\[31:0\] = 32'h00000001;   
  for(int i = 0; i &lt; 4;i++) begin   
     S00\_AXI\_test\_data\[i\] &lt;= mtestWDataL\[31:0\];     
   //AXI master write transaction  
   mst\_agent\_0.AXI4LITE\_WRITE\_BURST(   
   mtestADDR,   
   mtestProtectionType,   
   mtestWDataL,   
   mtestBresp   
   );     
   mtestWDataL\[31:0\] = mtestWDataL\[31:0\] + 1;   
   mtestADDR = mtestADDR + 64'h4;   
  end   
 $display(&quot;Sequential write transfers example similar to  AXI BFM WRITE\_BURST method completes&quot;);   
 $display(&quot;Sequential read transfers example similar to  AXI BFM READ\_BURST method starts&quot;);   
 mtestID = 0;   
 mtestADDR = 64'h00000000;   
 mtestBurstLength = 0;   
 mtestDataSize = xil\_axi\_size\_t'(xil\_clog2(32/8));   
 mtestBurstType = XIL\_AXI\_BURST\_TYPE\_INCR;    
 mtestLOCK = XIL\_AXI\_ALOCK\_NOLOCK;    
 mtestCacheType = 0;    
 mtestProtectionType = 0;    
 mtestRegion = 0;   
 mtestQOS = 0;   
 for(int i = 0; i &lt; 4;i++) begin   
   //AXI master產生read transaction  
   mst\_agent\_0.AXI4LITE\_READ\_BURST(   
        mtestADDR,   
        mtestProtectionType,   
        mtestRDataL,   
        mtestRresp   
      );   
  
  end   
endtask    
  
endmodule  

</code></pre><ul>
<li>
<p>對於slave agent有兩種model，分別是：</p>
</li>
<li>
<p>&lt;component_name&gt;_slv_t</p>
</li>
<li>
<p>必須自行在user environment(testbecnch)中補上write response與read response(response包含回傳訊息的內容等)</p>
</li>
<li>
<p>&lt;component_name&gt;_slv_mem_t</p>
</li>
<li>
<p>write response與read response會由agent自行處理</p>
</li>
<li>
<p>帶有memory model</p>
</li>
<li>
<p>對於AXI full master的ip，Vivado會預設使用此agent</p>
</li>
</ul>
<h4 id="heading"></h4>
<p>Testbench、AXI VIP與DUT的關係</p>
<p><a href="https://1.bp.blogspot.com/-r3aKB-f2IDw/Xncw6fxRhwI/AAAAAAAAHaE/gLq_o6EOm8UJjo2LYzY94_eFUJMslkUMwCLcBGAsYHQ/s1600/MS_AXI_test_plan.png"><img src="https://1.bp.blogspot.com/-r3aKB-f2IDw/Xncw6fxRhwI/AAAAAAAAHaE/gLq_o6EOm8UJjo2LYzY94_eFUJMslkUMwCLcBGAsYHQ/s640/MS_AXI_test_plan.png" alt=""></a></p>
<p>以此架構產生的目標測試環境如上所示。其中由於AXI VIP slave是使用memory mode，所以Slave write/read driver不需要user自己在testbench中補上處理程序。</p>
<p>在使用memory model版本的AXI VIP，可以透過blackdoor_memory_write與blackdoor_memory_read存取模擬出的data memory，而AXI master則可透過一般AXI transaction進行讀寫。memory model大小取決於AXI data width的定址空間大小。</p>
<p>blackdoor memory read範例:</p>
<pre><code>xil\_axi\_ulong mem\_rd\_addr = 32'h00000000;  
bit \[32-1:0\] mem\_rd\_data;  
mem\_rd\_data = slv\_agent\_0.mem\_model.backdoor\_memory\_read(mem\_rd\_addr);
```blackdoor memory write範例：  
</code></pre><p>bit [32-1:0] wr_data = 0;<br>
xil_axi_ulong wr_addr = 0;<br>
bit [(32/8)-1:0] wr_strb = 4&rsquo;hf; //byte select<br>
slv_agent_0.mem_model.backdoor_memory_write(wr_addr,wr_data,wr_strb);</p>
<pre><code>memory model使用上可以透過以下code將memory給入預設值方便debug:  
</code></pre><p>slv_agent_0.mem_model.set_memory_fill_policy(XIL_AXI_MEMORY_FILL_FIXED);<br>
slv_agent_0.mem_model.set_default_memory_value(32&rsquo;hdeadbeef);</p>
<pre><code>AXI master VIP進行AXI4 lite read/write的讀寫方式可透過:  
</code></pre><p>xil_axi_ulong                           mtestADDR;<br>
xil_axi_prot_t                          mtestProtectionType = 3&rsquo;b000;<br>
bit [63:0]                              mtestWDataL;<br>
bit [63:0]                              mtestRDataL;<br>
xil_axi_resp_t                          mtestBresp;<br>
xil_axi_resp_t[255:0]                   mtestRresp;<br>
mst_agent_0.AXI4LITE_WRITE_BURST(<br>
mtestADDR,<br>
mtestProtectionType,<br>
mtestWDataL,<br>
mtestBresp);<br>
mst_agent_0.AXI4LITE_READ_BURST(<br>
mtestADDR,<br>
mtestProtectionType,<br>
mtestRDataL,<br>
mtestRresp);</p>
<pre><code>
#### 示範testbench code

在gist連結中：[https://gist.github.com/Daichou/6b2e0a62bfc4eeb338e7f82fe40f0cc8](https://gist.github.com/Daichou/6b2e0a62bfc4eeb338e7f82fe40f0cc8)  

#### 其他資源

Xilinx AXI VIP很多資訊只能透過從範例code看註解學習，開啟範例的方法為，先建立一個AXI VIP block design，在block diagram中點擊AXI VIP按右鍵然後會跳出選單，選取open IP example design。在該專案根目錄底下的imports就會含有所有範例testbench。  
  

#### Reference

  

*   [AXI Verification IP v1.0](https://www.xilinx.com/support/documentation/ip_documentation/axi_vip/v1_0/pg267-axi-vip.pdf)
*   [Validating a master AXI4 interface using the Verification IP as a slave](https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/18841614/Validating+a+master+AXI4+interface+using+the+Verification+IP+as+a+slave)
*   [Validating a master AXI4 interface using the Verification IP as a slave (part 2)](https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/18841951/Validating+a+master+AXI4+interface+using+the+Verification+IP+as+a+slave+part+2)</code></pre>
        </p>
    </div>
    

    <div class="page-footer">
        
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://daichou.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>